<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Wins Dashboard</title>
  <link rel="stylesheet" href="admin.css" />
  <style>
    /* Basic modal styling */
    #modalOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      z-index: 999;
    }
    #editModal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 6px;
      max-width: 500px;
      width: 90%;
      display: none;
      z-index: 1000;
      max-height: 90vh;
      overflow-y: auto;
    }
    .btn {
      padding: 6px 12px;
      margin-right: 6px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
    }
    .btn:hover {
      background-color: #45a049;
    }
    .btn.deleteBtn {
      background-color: #f44336;
    }
    .btn.deleteBtn:hover {
      background-color: #da190b;
    }
    label {
      display: block;
      margin-bottom: 8px;
    }
    input[type="text"], input[type="date"], textarea {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      margin-top: 4px;
    }
    textarea {
      resize: vertical;
      height: 80px;
      font-family: monospace;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
      word-break: break-word;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Wins Dashboard</h1>

    <nav>
      <a href="admin-win.html" class="active">Wins</a>
      <a href="/admin-user.html">Users</a>
      <a href="/admin-tournament.html">Tournaments</a>
      <a href="/admin-fixture.html">Fixture</a>
      <a href="/admin-fixture-generated.html">Generated Fixtures</a>
    </nav>

    <table>
      <thead>
        <tr>
          <th>Tournament Unique ID</th>
          <th>Room ID</th>
          <th>Player 1 (ObjID)</th>
          <th>Player 1 Telegram ID</th>
          <th>Player 2 (ObjID)</th>
          <th>Player 2 Telegram ID</th>
          <th>Winner</th>
          <th>Winner Telegram ID</th>
          <th>Opponent</th>
          <th>Opponent Telegram ID</th>
          <th>Played At</th>
          <th>Final Board</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="winsTableBody">
        <!-- Rows populated dynamically -->
      </tbody>
    </table>
  </div>

  <!-- Modal Overlay -->
  <div id="modalOverlay"></div>

  <!-- Edit Modal -->
  <div id="editModal">
    <h2>Edit Match</h2>
    <form id="editForm">
      <input type="hidden" id="matchId" />
      
      <label>
        Tournament Unique ID:
        <input type="text" id="tournamentInput" readonly />
      </label>

      <label>
        Room ID:
        <input type="text" id="roomInput" readonly />
      </label>

      <label>
        Player 1 (ObjID):
        <input type="text" id="player1IdInput" readonly />
      </label>
      <label>
        Player 1 Telegram ID:
        <input type="text" id="player1TelegramInput" readonly />
      </label>

      <label>
        Player 2 (ObjID):
        <input type="text" id="player2IdInput" readonly />
      </label>
      <label>
        Player 2 Telegram ID:
        <input type="text" id="player2TelegramInput" readonly />
      </label>

      <label>
        Winner (1 or 2 or 0 for draw):
        <input type="number" id="winnerInput" min="0" max="2" required />
      </label>

      <label>
        Played Date:
        <input type="date" id="dateInput" required />
      </label>

      <label>
        Final Board (JSON):
        <textarea id="finalBoardInput" readonly></textarea>
      </label>

      <button type="submit" class="btn">Save</button>
      <button type="button" id="cancelBtn" class="btn" style="background-color:#f44336;">Cancel</button>
    </form>
  </div>

  <script>
    const modalOverlay = document.getElementById('modalOverlay');
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const tbody = document.getElementById('winsTableBody');

    let currentResults = [];

    function openEditModal(data) {
      document.getElementById('matchId').value = data.id;
      document.getElementById('tournamentInput').value = data.tournamentUniqueId || '';
      document.getElementById('roomInput').value = data.roomId || '';
      document.getElementById('player1IdInput').value = data.player1 || '';
      document.getElementById('player1TelegramInput').value = data.player1TelegramId || '';
      document.getElementById('player2IdInput').value = data.player2 || '';
      document.getElementById('player2TelegramInput').value = data.player2TelegramId || '';
      document.getElementById('winnerInput').value = data.winner;
      if (data.playedAt) {
        // format YYYY-MM-DD for input date value
        const date = new Date(data.playedAt);
        document.getElementById('dateInput').value = date.toISOString().split('T')[0];
      } else {
        document.getElementById('dateInput').value = '';
      }
      document.getElementById('finalBoardInput').value = JSON.stringify(data.finalBoard, null, 2) || '';
      modalOverlay.style.display = 'block';
      editModal.style.display = 'block';
    }

    function closeEditModal() {
      modalOverlay.style.display = 'none';
      editModal.style.display = 'none';
    }

    async function loadGameResults() {
      try {
        const res = await fetch('/api/admin/game-results');
        if (!res.ok) throw new Error('Failed to fetch game results');
        currentResults = await res.json();

        tbody.innerHTML = '';

        currentResults.forEach(result => {
          // Determine winner/opponent names and telegram ids for display
          const winnerName = (result.winner === 1) ? (result.player1TelegramId || result.player1) :
                             (result.winner === 2) ? (result.player2TelegramId || result.player2) : 'Draw';

          const opponentTelegram = (result.winner === 1) ? (result.player2TelegramId || result.player2) :
                                   (result.winner === 2) ? (result.player1TelegramId || result.player1) : '';

          const opponentName = opponentTelegram || 'N/A';

          const playedDate = result.playedAt ? new Date(result.playedAt).toISOString().split('T')[0] : 'N/A';

          const finalBoardText = result.finalBoard ? JSON.stringify(result.finalBoard) : '';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${result.tournamentUniqueId || 'N/A'}</td>
            <td>${result.roomId || 'N/A'}</td>
            <td>${result.player1 || 'N/A'}</td>
            <td>${result.player1TelegramId || 'N/A'}</td>
            <td>${result.player2 || 'N/A'}</td>
            <td>${result.player2TelegramId || 'N/A'}</td>
            <td>${winnerName}</td>
            <td>${winnerName}</td>
            <td>${opponentName}</td>
            <td>${opponentTelegram || 'N/A'}</td>
            <td>${playedDate}</td>
            <td><pre style="white-space: pre-wrap; max-width: 150px; overflow-x: auto;">${finalBoardText}</pre></td>
            <td>
              <button class="btn editBtn" data-id="${result.id}">Edit</button>
              <button class="btn deleteBtn" data-id="${result.id}">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        document.querySelectorAll('.editBtn').forEach(btn => {
          btn.addEventListener('click', e => {
            const id = e.target.getAttribute('data-id');
            const match = currentResults.find(r => r.id === id);
            if (match) openEditModal(match);
          });
        });

        document.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.addEventListener('click', async e => {
            const id = e.target.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this match?')) {
              try {
                const res = await fetch(`/api/admin/game-results/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Delete failed');
                alert('Match deleted.');
                loadGameResults();
              } catch (err) {
                alert('Failed to delete match.');
              }
            }
          });
        });

      } catch (err) {
        console.error(err);
        alert('Error loading game results.');
      }
    }

    cancelBtn.addEventListener('click', closeEditModal);
    modalOverlay.addEventListener('click', closeEditModal);

    editForm.addEventListener('submit', async e => {
      e.preventDefault();

      const id = document.getElementById('matchId').value;
      const updatedData = {
        tournamentUniqueId: document.getElementById('tournamentInput').value,
        winner: Number(document.getElementById('winnerInput').value),
        playedAt: document.getElementById('dateInput').value,
      };

      try {
        const res = await fetch(`/api/admin/game-results/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData),
        });
        if (!res.ok) throw new Error('Update failed');
        alert('Match updated.');
        closeEditModal();
        loadGameResults();
      } catch (err) {
        alert('Failed to update match.');
      }
    });

    window.onload = loadGameResults;
  </script>
</body>
</html>
